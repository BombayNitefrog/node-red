# Get averages of sensor data
[{"id":"2ad773d5.31ee7c","type":"mqtt in","z":"d404d6b5.5c436","name":"","topic":"test/#","qos":"2","datatype":"json","broker":"b700a1d5.e877","x":230,"y":200,"wires":[["37b1b765.f7c4e"]]},{"id":"37b1b765.f7c4e","type":"join","z":"d404d6b5.5c436","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":370,"y":200,"wires":[["d8e10d1f.8c6da"]]},{"id":"d8e10d1f.8c6da","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"payload.averageTemperature","pt":"msg","to":"$average(msg.payload.*.temperature)","tot":"jsonata"},{"t":"set","p":"payload.averageCo2","pt":"msg","to":"$average(msg.payload.*.co2)","tot":"jsonata"},{"t":"set","p":"payload.averageHumidity","pt":"msg","to":"$average(msg.payload.*.humidity)","tot":"jsonata"},{"t":"set","p":"payload.averageBattery","pt":"msg","to":"$average(msg.payload.*.battery)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":200,"wires":[[]]},{"id":"57f963d6.d7629c","type":"comment","z":"d404d6b5.5c436","name":"average sensor values","info":"","x":270,"y":140,"wires":[]},{"id":"b700a1d5.e877","type":"mqtt-broker","name":"","broker":"test.ka9n.dk","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""}]

# EiSE setpoint calculation
[{"id":"a5be6010.ab9cf8","type":"comment","z":"d404d6b5.5c436","name":"EiSE","info":"","x":210,"y":340,"wires":[]},{"id":"48de48ae.3f5a48","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"(($millis() ~> $fromMillis('[H]') ~> $number()) >= 4 ? \t    ($millis() ~> $fromMillis('[H]') ~> $number()) \t: \t    ($millis() ~> $fromMillis('[H]') ~> $number()) + 23) \t\t+ (($millis() ~> $fromMillis('[m]') ~> $number())/60) \t- 4","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":400,"wires":[["ab9e2474.43bed"]]},{"id":"daedbbea.a3752","type":"inject","z":"d404d6b5.5c436","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"5","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":250,"y":400,"wires":[["48de48ae.3f5a48"]]},{"id":"ab9e2474.43bed","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload >= 14 ?\t(10-(payload - 14))/10\t:\tpayload/14","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":400,"wires":[["5794e7a5.0a608","5a59e319.10ebd4","1cc705f4.c2d1f2","9df546c5.60a328","44688a2a.27995c","a32a9f8.4d5b7e"]]},{"id":"5794e7a5.0a608","type":"range","z":"d404d6b5.5c436","minin":"0","maxin":"1","minout":"23","maxout":"25","action":"scale","round":false,"property":"payload","name":"","x":900,"y":280,"wires":[["51ae3b7c.e5cc54"]]},{"id":"5a59e319.10ebd4","type":"range","z":"d404d6b5.5c436","minin":"0","maxin":"1","minout":"21","maxout":"19","action":"scale","round":false,"property":"payload","name":"","x":900,"y":320,"wires":[["74d3db30.b4916c"]]},{"id":"8895a30f.fe778","type":"join","z":"d404d6b5.5c436","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1250,"y":300,"wires":[[]]},{"id":"51ae3b7c.e5cc54","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"Cooling","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":280,"wires":[["8895a30f.fe778"]]},{"id":"74d3db30.b4916c","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"Heating","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":320,"wires":[["8895a30f.fe778"]]},{"id":"1cc705f4.c2d1f2","type":"range","z":"d404d6b5.5c436","minin":"0","maxin":"1","minout":"23","maxout":"25","action":"scale","round":false,"property":"payload","name":"","x":900,"y":380,"wires":[["8d12df33.28b108"]]},{"id":"9df546c5.60a328","type":"range","z":"d404d6b5.5c436","minin":"0","maxin":"1","minout":"19","maxout":"18","action":"scale","round":false,"property":"payload","name":"","x":900,"y":420,"wires":[["e1ff907c.4ecfc8"]]},{"id":"8aebf042.457048","type":"join","z":"d404d6b5.5c436","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1250,"y":400,"wires":[[]]},{"id":"8d12df33.28b108","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"Cooling","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":380,"wires":[["8aebf042.457048"]]},{"id":"e1ff907c.4ecfc8","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"Heating","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":420,"wires":[["8aebf042.457048"]]},{"id":"5a7f59cb.1ad2c8","type":"comment","z":"d404d6b5.5c436","name":"Office","info":"","x":1390,"y":300,"wires":[]},{"id":"ebfad8b7.c46a3","type":"comment","z":"d404d6b5.5c436","name":"Institution","info":"","x":1400,"y":400,"wires":[]},{"id":"b073470d.910a7","type":"comment","z":"d404d6b5.5c436","name":"Nursing","info":"","x":1390,"y":500,"wires":[]},{"id":"44688a2a.27995c","type":"range","z":"d404d6b5.5c436","minin":"0","maxin":"1","minout":"24","maxout":"26","action":"scale","round":false,"property":"payload","name":"","x":900,"y":480,"wires":[["accbebee.01c2"]]},{"id":"a32a9f8.4d5b7e","type":"range","z":"d404d6b5.5c436","minin":"0","maxin":"1","minout":"23","maxout":"22","action":"scale","round":false,"property":"payload","name":"","x":900,"y":520,"wires":[["1eea30b5.ed009f"]]},{"id":"ba54041f.633868","type":"join","z":"d404d6b5.5c436","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"2","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1250,"y":500,"wires":[[]]},{"id":"accbebee.01c2","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"Cooling","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":480,"wires":[["ba54041f.633868"]]},{"id":"1eea30b5.ed009f","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"Heating","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":520,"wires":[["ba54041f.633868"]]}]

# Holidays
[{"id":"c3ef593a.39d62","type":"require","z":"d404d6b5.5c436","name":"","module":"date-holidays","field":"payload","fieldType":"msg","x":470,"y":700,"wires":[["46ee649d.8416cc"]]},{"id":"66f6c86c.7e8868","type":"function","z":"d404d6b5.5c436","name":"","func":"var hd = new msg.payload.req(\"DK\")\nvar date = new Date(msg.payload.time*1000)\nvar year = date.getYear() -100 +2000\nvar month = date.getMonth() + 1\nvar today = year+\"-\"+month+\"-\"+ date.getDate()\n\nvar hellig = hd.isHoliday(new Date( today+ ' 00:00:00 GMT+0000'))\nif(!hellig){\n    hellig = {\n        \"name\": \"hverdag\",\n        \"type\": \"workday\"\n    }\n}\n\nmsg.payload = hellig\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1020,"y":760,"wires":[["33e46f52.a57de"]]},{"id":"64083530.89bbdc","type":"comment","z":"d404d6b5.5c436","name":"Helligdage","info":"","x":220,"y":700,"wires":[]},{"id":"573aafe8.adf13","type":"inject","z":"d404d6b5.5c436","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"time","payload":"","payloadType":"date","x":260,"y":760,"wires":[["c3ef593a.39d62","2bb8a74.8d285d8"]]},{"id":"2bb8a74.8d285d8","type":"join","z":"d404d6b5.5c436","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":850,"y":760,"wires":[["66f6c86c.7e8868"]]},{"id":"46ee649d.8416cc","type":"change","z":"d404d6b5.5c436","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"req","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":700,"wires":[["2bb8a74.8d285d8"]]},{"id":"33e46f52.a57de","type":"switch","z":"d404d6b5.5c436","name":"","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"public","vt":"str"},{"t":"eq","v":"bank","vt":"str"},{"t":"eq","v":"school","vt":"str"},{"t":"eq","v":"optional","vt":"str"},{"t":"eq","v":"observance","vt":"str"},{"t":"eq","v":"workday","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":1190,"y":760,"wires":[[],[],[],[],[],[]]}]


